// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User/Athlete model
model Athlete {
  id            Int            @id
  username      String?
  firstname     String
  lastname      String
  profileMedium String?        @map("profile_medium")
  profile       String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  
  activities    Activity[]
  achievements  Achievement[]
  stats         AthleteStats[]

  @@map("athletes")
}

// Activity model - stores all runs
model Activity {
  id                  BigInt   @id
  athleteId           Int      @map("athlete_id")
  name                String
  distance            Float
  movingTime          Int      @map("moving_time")
  elapsedTime         Int      @map("elapsed_time")
  totalElevationGain  Float    @map("total_elevation_gain")
  type                String
  startDate           DateTime @map("start_date")
  startDateLocal      DateTime @map("start_date_local")
  averageSpeed        Float    @map("average_speed")
  maxSpeed            Float    @map("max_speed")
  averageHeartrate    Float?   @map("average_heartrate")
  maxHeartrate        Float?   @map("max_heartrate")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@index([startDateLocal])
  @@map("activities")
}

// Achievement tracking - records when achievements are unlocked
model Achievement {
  id          String   @id @default(cuid())
  athleteId   Int      @map("athlete_id")
  achievementId String @map("achievement_id") // e.g., "first_step", "century"
  name        String
  description String
  unlockedAt  DateTime @default(now()) @map("unlocked_at")

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([athleteId, achievementId])
  @@index([athleteId])
  @@map("achievements")
}

// Athlete stats snapshot - periodically stored for historical tracking
model AthleteStats {
  id                    String   @id @default(cuid())
  athleteId             Int      @map("athlete_id")
  allRunCount           Int      @map("all_run_count")
  allRunDistance        Float    @map("all_run_distance")
  allRunMovingTime      Int      @map("all_run_moving_time")
  allRunElevationGain   Float    @map("all_run_elevation_gain")
  ytdRunCount           Int      @map("ytd_run_count")
  ytdRunDistance        Float    @map("ytd_run_distance")
  ytdRunMovingTime      Int      @map("ytd_run_moving_time")
  ytdRunElevationGain   Float    @map("ytd_run_elevation_gain")
  snapshotDate          DateTime @default(now()) @map("snapshot_date")

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@index([snapshotDate])
  @@map("athlete_stats")
}

